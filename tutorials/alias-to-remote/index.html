<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../../css/style2.css">
  <link rel="stylesheet" href="../../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>Forward messages to a remote MX - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="../..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="forward-messages-to-a-remote-mx">Forward messages to a remote MX</h1>
<p>Default maddy configuration is done in a way that does not result in any
outbound messages being sent as a result of port 25 traffic.</p>
<p>In particular, this means that if you handle messages for example.org but not
example.com and have the following in your aliases file (e.g. /etc/maddy/aliases):</p>
<pre class="codehilite"><code>foxcpp@example.org: foxcpp@example.com
</code></pre>

<p>You will get "User does not exist" error when attempting to send a message to
foxcpp@example.org because foxcpp@example.com does not exist on as a local
user.</p>
<p>Some users may want to make it work, but it is important to understand the
consequences of such configuration:</p>
<ul>
<li>Flooding your server will also flood the remote server.</li>
<li>If your spam filtering is not good enough, you will send spam to the remote
  server.</li>
</ul>
<p>In both cases, you might harm the reputation of your server (e.g. get your IP
listed in a DNSBL).</p>
<p><strong>So, this is a bad practice. Do so only if you clearly understand the
consequences (including the Bounce handling section below).</strong></p>
<p>If you want to do it anyway, here is the part of the configuration that needs
tweaking:</p>
<pre class="codehilite"><code>msgpipeline local_routing {
    destination postmaster $(local_domains) {
        modify {
            replace_rcpt regexp &quot;(.+)\+(.+)@(.+)&quot; &quot;$1@$3&quot;
            replace_rcpt file /etc/maddy/aliases
        }

        deliver_to &amp;local_mailboxes
    }

    default_destination {
        reject 550 5.1.1 &quot;User doesn't exist&quot;
    }
}
</code></pre>

<p>In default configuration, <code>local_routing</code> block is responsible for handling
messages that are received via SMTP or Submission and have the initial
destination address at a local domain.</p>
<p>Note the <code>modify { }</code> block being nested inside <code>destination</code> and then followed
by unconditional <code>deliver_to &amp;local_mailboxes</code>. This means: if address is
on <code>$(local_domains)</code>, apply aliases and deliver to mailboxes from
<code>&amp;local_mailboxes</code>.</p>
<p>The problem here is that recipients are matched before aliases are resolved so
in the end, maddy attempts to look up foxcpp@example.com locally. The solution
is to insert another step into the pipeline configuration to rerun matching
<em>after</em> aliases are resolved. This can be done using the 'reroute' directive:</p>
<pre class="codehilite"><code>msgpipeline local_routing {
    destination postmaster $(local_domains) {
        modify {
            replace_rcpt file /etc/maddy/aliases
            ...
        }

        reroute {
            destination postmaster $(local_domains) {
                deliver_to &amp;local_mailboxes
            }
            default_destination {
                deliver_to &amp;remote_queue
            }
        }
    }

    default_destination {
        reject 550 5.1.1 &quot;User doesn't exist&quot;
    }
}
</code></pre>

<h2 id="bounce-handling">Bounce handling</h2>
<p>Once the message is delivered to <code>remote_queue</code>, it will follow the usual path
for outbound delivery, including queueing and multiple attempts. This also
means bounce messages will be generated on failures. When accepting messages
from arbitrary senders via the 25 port, the DSN recipient will be whatever
sender specifies in the MAIL FROM command. This is prone to <a href="https://en.wikipedia.org/wiki/Backscatter_(e-mail)">collateral spam</a>
when an automatically generated bounce message gets sent to a spoofed address.</p>
<p>However, the default maddy configuration ensures that in this case, the NDN
will be delivered only if the original sender is a local user. Backscatter can
not happen if the sender spoofed a local address since such messages will not
be accepted in the first place.</p>
<p>You can also configure maddy to send bounce messages to remote
addresses, but in this case, you should configure a really strict local policy
to make sure the sender address is not spoofed. There is no detailed
explanation of how to do this since this is a terrible idea in general.</p>
<h2 id="transparent-forwarding">Transparent forwarding</h2>
<p>As an alternative to silently dropping messages on remote delivery failures,
you might want to use transparent forwarding and reject the message without
accepting it first ("connection-stage rejection").</p>
<p>To do so, simply do not use the queue, replace</p>
<pre class="codehilite"><code>deliver_to &amp;remote_queue
</code></pre>

<p>with</p>
<pre class="codehilite"><code>deliver_to &amp;outbound_delivery
</code></pre>

<p>(assuming outbound_delivery refers to target.remote block)</p>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="./"
				class="current">
			Forward messages to a remote MX</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#bounce-handling">Bounce handling</a>
                    </li>
                
                    <li class="local">
                        <a href="#transparent-forwarding">Transparent forwarding</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>
            
                <li>
		<a href="../pam/"
				class="">
			Using PAM authentication</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="../../multiple-domains/"
				class="">
			Multiple domains configuration</a>

        
    </li>

    <li>
		<a href="../../upgrading/"
				class="">
			Upgrading from older maddy versions</a>

        
    </li>

    <li>
		<a href="../../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../../reference/modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../../reference/global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../../reference/tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../../reference/tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../../reference/endpoints/imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="../../reference/endpoints/smtp/"
				class="">
			SMTP/LMTP/Submission endpoint</a>

        
    </li>
            
                <li>
		<a href="../../reference/endpoints/openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../../reference/storage/imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="../../reference/storage/imapsql/"
				class="">
			SQL-indexed storage</a>

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../../reference/blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../../reference/blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../reference/smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../../reference/targets/queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="../../reference/targets/remote/"
				class="">
			Remote MX delivery</a>

        
    </li>
            
                <li>
		<a href="../../reference/targets/smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../../reference/checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../../reference/modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../../reference/modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../../reference/table/static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/sql_query/"
				class="">
			SQL query mapping</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../../reference/auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../reference/config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '../..';</script>
<script src="../../search/main.js" defer></script>


</body>
</html>

