<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../../css/style2.css">
  <link rel="stylesheet" href="../../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>Using PAM authentication - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="../..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="using-pam-authentication">Using PAM authentication</h1>
<p>maddy supports user authentication using PAM infrastructure via <code>auth.pam</code>
module.</p>
<p>In order to use it, however, either maddy itself should be compiled
with libpam support or a helper executable should be built and
installed into an appropriate directory.</p>
<p>It is recommended to use builtin libpam support if you are using
PAM as an intermediate for authentication provider not directly
supported by maddy.</p>
<p>If PAM authentication requires privileged access on the host system
(e.g. pam_unix.so aka /etc/shadow) then it is recommended to use
a privileged helper executable since maddy process itself won't
have access to it.</p>
<h2 id="built-in-pam-support">Built-in PAM support</h2>
<p>Binary artifacts provided for releases do not come with
libpam support. You should build maddy from source.</p>
<p>See <a href="../building-from-source">here</a> for detailed instructions.</p>
<p>You should have libpam development files installed (<code>libpam-dev</code>
package on Ubuntu/Debian).</p>
<p>Then add <code>--tags 'libpam'</code> to the build command:</p>
<pre class="codehilite"><code>./build.sh --tags 'libpam'
</code></pre>

<p>Then you should be able to replace <code>local_authdb</code> implementation
in default configuration with <code>auth.pam</code>:</p>
<pre class="codehilite"><code>auth.pam local_authdb {
    use_helper no
}
</code></pre>

<h2 id="helper-executable">Helper executable</h2>
<p>TL;DR</p>
<pre class="codehilite"><code>git clone https://github.com/foxcpp/maddy
cd maddy/cmd/maddy-pam-helper
gcc pam.c main.c -lpam -o maddy-pam-helper
</code></pre>

<p>Copy the resulting executable into /usr/lib/maddy/ and make
it setuid-root so it can read /etc/shadow (if that's necessary):</p>
<pre class="codehilite"><code>chown root:maddy /usr/lib/maddy/maddy-pam-helper
chmod u+xs,g+x,o-x /usr/lib/maddy/maddy-pam-helper
</code></pre>

<p>Then you should be able to replace <code>local_authdb</code> implementation
in default configuration with <code>auth.pam</code>:</p>
<pre class="codehilite"><code>auth.pam local_authdb {
    use_helper yes
}
</code></pre>

<h2 id="account-names">Account names</h2>
<p>Since PAM does not use emails for authentication you should also
configure storage backend to use username only as an account identifier,
not full email addresses:</p>
<pre class="codehilite"><code>storage.imapsql local_mailboxes {
    ...
    delivery_map email_localpart
    auth_normalize precis_casefold
}
</code></pre>

<p>This way, when authenticating as <code>foxcpp</code>, it will be mapped to
<code>foxcpp</code> storage account. E.g. you will need to run
<code>maddy imap-accts create foxcpp</code>, without the domain part.</p>
<p>If you have existing accounts, you will need to rename them.</p>
<p>Change to <code>auth_normalize</code> is necessary so that normalization function
will not attempt to parse authentication identity as a email.</p>
<p>When a email is received, <code>delivery_map email_localpart</code> will strip
the domain part before looking up the account. That is,
<code>foxcpp@example.org</code> will be become just <code>foxcpp</code>.</p>
<p>You also need to make <code>authorize_sender</code> check (used in <code>submission</code> endpoint)
accept non-email usernames:</p>
<pre class="codehilite"><code>authorize_sender {
  ...
  auth_normalize precis_casefold
  user_to_email regexp &quot;(.*)&quot; &quot;$1@$(primary_domain)&quot;
}
</code></pre>

<p>Note that is would work only if clients use only one domain as sender (<code>$(primary_domain)</code>).
If you want to allow sending from all domains, you need to remove <code>authorize_sender</code> check
altogether since it is not currently supported.</p>
<h2 id="pam-service">PAM service</h2>
<p>You should create a PAM configuration file for maddy to use.
Place it into /etc/pam.d/maddy.
Here is the minimal example using pam_unix (shadow database).</p>
<pre class="codehilite"><code>#%PAM-1.0
auth    required    pam_unix.so
account required    pam_unix.so
</code></pre>

<p>Here is the configuration example you could use on Ubuntu
to use the authentication config system itself uses:</p>
<pre class="codehilite"><code>#%PAM-1.0

@include common-auth
@include common-account
@include common-session
</code></pre>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="../alias-to-remote/"
				class="">
			Forward messages to a remote MX</a>

        
    </li>
            
                <li>
		<a href="./"
				class="current">
			Using PAM authentication</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#built-in-pam-support">Built-in PAM support</a>
                    </li>
                
                    <li class="local">
                        <a href="#helper-executable">Helper executable</a>
                    </li>
                
                    <li class="local">
                        <a href="#account-names">Account names</a>
                    </li>
                
                    <li class="local">
                        <a href="#pam-service">PAM service</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="../../multiple-domains/"
				class="">
			Multiple domains configuration</a>

        
    </li>

    <li>
		<a href="../../upgrading/"
				class="">
			Upgrading from older maddy versions</a>

        
    </li>

    <li>
		<a href="../../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../../reference/modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../../reference/global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../../reference/tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../../reference/tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../../reference/endpoints/imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="../../reference/endpoints/smtp/"
				class="">
			SMTP/LMTP/Submission endpoint</a>

        
    </li>
            
                <li>
		<a href="../../reference/endpoints/openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../../reference/storage/imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="../../reference/storage/imapsql/"
				class="">
			SQL-indexed storage</a>

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../../reference/blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../../reference/blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../reference/smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../../reference/targets/queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="../../reference/targets/remote/"
				class="">
			Remote MX delivery</a>

        
    </li>
            
                <li>
		<a href="../../reference/targets/smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../../reference/checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../../reference/checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../../reference/modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../../reference/modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../../reference/table/static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/sql_query/"
				class="">
			SQL query mapping</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../../reference/table/auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../../reference/auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../../reference/auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../reference/config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '../..';</script>
<script src="../../search/main.js" defer></script>


</body>
</html>

