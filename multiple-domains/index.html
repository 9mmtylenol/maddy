<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../css/style2.css">
  <link rel="stylesheet" href="../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>Multiple domains configuration - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="multiple-domains-configuration">Multiple domains configuration</h1>
<h2 id="separate-account-namespaces">Separate account namespaces</h2>
<p>Given two domains, example.org and example.com. foo@example.org and
foo@example.com are different and completely independent accounts.</p>
<p>All changes needed to make it work is to make sure all domains are specified in
the <code>$(local_domains)</code> macro in the main configuration file. Note that you need
to pick one domain as a "primary" for use in auto-generated messages.</p>
<pre class="codehilite"><code>$(primary_domain) = example.org
$(local_domains) = $(primary_domain) example.com
</code></pre>

<p>The base configuration is done. You can create accounts using
both domains in the name, send and receive messages and so on.  Do not forget
to configure corresponding SPF, DMARC and MTA-STS records as was
recommended in the <a href="../tutorials/setting-up/">introduction tutorial</a>.</p>
<h2 id="single-account-namespace">Single account namespace</h2>
<p>You can configure maddy to only use local part of the email
as an account identifier instead of the complete email.</p>
<p>This needs two changes to default configuration:</p>
<pre class="codehilite"><code>storage.imapsql local_mailboxes {
    ...
    delivery_map email_localpart
    auth_normalize precis_casefold
}
</code></pre>

<p>This way, when authenticating as <code>foxcpp</code>, it will be mapped to
<code>foxcpp</code> storage account. E.g. you will need to run
<code>maddy imap-accts create foxcpp</code>, without the domain part.</p>
<p>If you have existing accounts, you will need to rename them.</p>
<p>Change to <code>auth_normalize</code> is necessary so that normalization function
will not attempt to parse authentication identity as a email.</p>
<p>When a email is received, <code>delivery_map email_localpart</code> will strip
the domain part before looking up the account. That is,
<code>foxcpp@example.org</code> will be become just <code>foxcpp</code>.</p>
<p>You also need to make <code>authorize_sender</code> check (used in <code>submission</code> endpoint)
accept non-email usernames:</p>
<pre class="codehilite"><code>authorize_sender {
  ...
  auth_normalize precis_casefold
  user_to_email regexp &quot;(.*)&quot; &quot;$1@$(primary_domain)&quot;
}
</code></pre>

<p>Note that is would work only if clients use only one domain as sender (<code>$(primary_domain)</code>).
If you want to allow sending from all domains, you need to remove <code>authorize_sender</code> check
altogether since it is not currently supported.</p>
<p>After that you can create accounts without specifying the domain part:</p>
<pre class="codehilite"><code>maddy imap-acct create foxcpp
maddy creds create foxcpp
</code></pre>

<p>And authenticate using "foxcpp" in email clients.</p>
<p>Messages for any foxcpp@* address with a domain in <code>$(local_domains)</code>
will be delivered to that mailbox.</p>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../tutorials/setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../tutorials/building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="../tutorials/alias-to-remote/"
				class="">
			Forward messages to a remote MX</a>

        
    </li>
            
                <li>
		<a href="../tutorials/pam/"
				class="">
			Using PAM authentication</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="./"
				class="current">
			Multiple domains configuration</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#separate-account-namespaces">Separate account namespaces</a>
                    </li>
                
                    <li class="local">
                        <a href="#single-account-namespace">Single account namespace</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>

    <li>
		<a href="../upgrading/"
				class="">
			Upgrading from older maddy versions</a>

        
    </li>

    <li>
		<a href="../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../reference/modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../reference/global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../reference/tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../reference/tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../reference/endpoints/imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="../reference/endpoints/smtp/"
				class="">
			SMTP/LMTP/Submission endpoint</a>

        
    </li>
            
                <li>
		<a href="../reference/endpoints/openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../reference/storage/imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="../reference/storage/imapsql/"
				class="">
			SQL-indexed storage</a>

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../reference/blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../reference/blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../reference/smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../reference/targets/queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="../reference/targets/remote/"
				class="">
			Remote MX delivery</a>

        
    </li>
            
                <li>
		<a href="../reference/targets/smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../reference/checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../reference/modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../reference/modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../reference/table/static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../reference/table/regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../reference/table/file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="../reference/table/sql_query/"
				class="">
			SQL query mapping</a>

        
    </li>
            
                <li>
		<a href="../reference/table/chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../reference/table/email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../reference/table/auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../reference/auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../reference/config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '..';</script>
<script src="../search/main.js" defer></script>


</body>
</html>

