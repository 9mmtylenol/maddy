<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../css/style2.css">
  <link rel="stylesheet" href="../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>Upgrading from older maddy versions - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="upgrading-from-older-maddy-versions">Upgrading from older maddy versions</h1>
<p>It is generally possible to just install latest version (e.g. using build.sh
script) over the existing installation.</p>
<p>It is recommended to backup state directory (usually /var/lib/maddy for Linux)
before doing so. The new server version may automatically convert DB files in a
way that will make them unreadable by older versions.</p>
<p>Specific instructions for upgrading between versions with incompatible changes
are documented on this page below.</p>
<h2 id="incompatible-version-migration">Incompatible version migration</h2>
<h2 id="02-03">0.2 -&gt; 0.3</h2>
<p>0.3 includes a significant change to the authentication code that makes it
completely independent of IMAP index. This means 0.2 "unified" database cannot
be used in 0.3 and auto-migration is not possible. Additionally, the way
passwords are hashed is changed, meaning that after migration passwords will
need to be reset.</p>
<p><strong>Migration utility is SQLite-specific, if you need one that works for
Postgres - reach out at the IRC channel.</strong></p>
<ol>
<li>Make sure the server is not running.</li>
</ol>
<pre class="codehilite"><code>systemctl stop maddy
</code></pre>

<ol>
<li>Take a backup of <code>imapsql.db*</code> files in state directory (/var/lib/maddy).</li>
</ol>
<pre class="codehilite"><code>mkdir backup
cp /var/lib/maddy/imapsql.db* backup/
</code></pre>

<ol>
<li>Compile migration utility:</li>
</ol>
<pre class="codehilite"><code>git clone https://github.com/foxcpp/maddy.git
cd maddy/
git checkout v0.3.0
cd cmd/migrate-db-0.2
go build
</code></pre>

<ol>
<li>Run compiled binary:</li>
</ol>
<pre class="codehilite"><code>./migrate-db-0.2 /var/lib/maddy/imapsql.db
</code></pre>

<ol>
<li>Open maddy.conf and make following changes:</li>
</ol>
<p>Remove <code>local_authdb</code> name from imapsql configuration block:</p>
<pre class="codehilite"><code>imapsql local_mailboxes {
    driver sqlite3
    dsn imapsql.db
}
</code></pre>

<p>Add <code>local_authdb</code> configuration block using <code>pass_table</code> module:</p>
<pre class="codehilite"><code>pass_table local_authdb {
    table sql_table {
        driver sqlite3
        dsn credentials.db
        table_name passwords
    }
}
</code></pre>

<ol>
<li>
<p>Use <code>maddy creds create ACCOUNT_NAME</code> to add credentials to <code>pass_table</code>
   store.</p>
</li>
<li>
<p>Start the server back.</p>
</li>
</ol>
<pre class="codehilite"><code>systemctl start maddy
</code></pre>

<h2 id="01-02">0.1 -&gt; 0.2</h2>
<p>0.2 requires several changes in configuration file.</p>
<p>Change</p>
<pre class="codehilite"><code>sql local_mailboxes local_authdb {
</code></pre>

<p>to</p>
<pre class="codehilite"><code>imapsql local_mailboxes local_authdb {
</code></pre>

<p>Replace</p>
<pre class="codehilite"><code>replace_rcpt postmaster postmaster@$(primary_domain)
</code></pre>

<p>with</p>
<pre class="codehilite"><code>replace_rcpt static {
    entry postmaster postmaster@$(primary_domain)
}
</code></pre>

<p>and</p>
<pre class="codehilite"><code>replace_rcpt &quot;(.+)\+(.+)@(.+)&quot; &quot;$1@$3&quot;
</code></pre>

<p>with</p>
<pre class="codehilite"><code>replace_rcpt regexp &quot;(.+)\+(.+)@(.+)&quot; &quot;$1@$3&quot;
</code></pre>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../tutorials/setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../tutorials/building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="../tutorials/alias-to-remote/"
				class="">
			Forward messages to a remote MX</a>

        
    </li>
            
                <li>
		<a href="../tutorials/pam/"
				class="">
			Using PAM authentication</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="../multiple-domains/"
				class="">
			Multiple domains configuration</a>

        
    </li>

    <li>
		<a href="./"
				class="current">
			Upgrading from older maddy versions</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#incompatible-version-migration">Incompatible version migration</a>
                    </li>
                
                    <li class="local">
                        <a href="#02-03">0.2 -&gt; 0.3</a>
                    </li>
                
                    <li class="local">
                        <a href="#01-02">0.1 -&gt; 0.2</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>

    <li>
		<a href="../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../reference/modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../reference/global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../reference/tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../reference/tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../reference/endpoints/imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="../reference/endpoints/smtp/"
				class="">
			SMTP/LMTP/Submission endpoint</a>

        
    </li>
            
                <li>
		<a href="../reference/endpoints/openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../reference/storage/imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="../reference/storage/imapsql/"
				class="">
			SQL-indexed storage</a>

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../reference/blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../reference/blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../reference/smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../reference/targets/queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="../reference/targets/remote/"
				class="">
			Remote MX delivery</a>

        
    </li>
            
                <li>
		<a href="../reference/targets/smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../reference/checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../reference/checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../reference/modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../reference/modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../reference/table/static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../reference/table/regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../reference/table/file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="../reference/table/sql_query/"
				class="">
			SQL query mapping</a>

        
    </li>
            
                <li>
		<a href="../reference/table/chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../reference/table/email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../reference/table/auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../reference/auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../reference/auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../reference/config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '..';</script>
<script src="../search/main.js" defer></script>


</body>
</html>

