<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../../../css/style2.css">
  <link rel="stylesheet" href="../../../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>SQL-indexed storage - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="../../..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="sql-indexed-storage">SQL-indexed storage</h1>
<p>The imapsql module implements database for IMAP index and message
metadata using SQL-based relational database.</p>
<p>Message contents are stored in an "blob store" defined by msg_store
directive. By default this is a file system directory under /var/lib/maddy.</p>
<p>Supported RDBMS:
- SQLite 3.25.0
- PostgreSQL 9.6 or newer
- CockroachDB 20.1.5 or newer</p>
<p>Account names are required to have the form of a email address (unless configured otherwise)
and are case-insensitive. UTF-8 names are supported with restrictions defined in the
PRECIS UsernameCaseMapped profile.</p>
<pre class="codehilite"><code>storage.imapsql {
    driver sqlite3
    dsn imapsql.db
    msg_store fs messages/
}
</code></pre>

<p>imapsql module also can be used as a lookup table.
It returns empty string values for existing usernames. This might be useful
with destination_in directive e.g. to implement catch-all
addresses (this is a bad idea to do so, this is just an example):</p>
<pre class="codehilite"><code>destination_in &amp;local_mailboxes {
    deliver_to &amp;local_mailboxes
}
destination example.org {
    modify {
        replace_rcpt regexp &quot;.*&quot; &quot;catchall@example.org&quot;
    }
    deliver_to &amp;local_mailboxes
}
</code></pre>

<h2 id="arguments">Arguments</h2>
<p>Specify the driver and DSN.</p>
<h2 id="configuration-directives">Configuration directives</h2>
<p><strong>Syntax</strong>: driver <em>string</em> <br>
<strong>Default</strong>: not specified</p>
<p>REQUIRED.</p>
<p>Use a specified driver to communicate with the database. Supported values:
sqlite3, postgres.</p>
<p>Should be specified either via an argument or via this directive.</p>
<p><strong>Syntax</strong>: dsn <em>string</em> <br>
<strong>Default</strong>: not specified</p>
<p>REQUIRED.</p>
<p>Data Source Name, the driver-specific value that specifies the database to use.</p>
<p>For SQLite3 this is just a file path.
For PostgreSQL: <a href="https://godoc.org/github.com/lib/pq#hdr-Connection_String_Parameters">https://godoc.org/github.com/lib/pq#hdr-Connection_String_Parameters</a></p>
<p>Should be specified either via an argument or via this directive.</p>
<p><strong>Syntax</strong>: msg_store <em>store</em> <br>
<strong>Default</strong>: fs messages/</p>
<p>Module to use for message bodies storage.</p>
<p>See "Blob storage" section for what you can use here.</p>
<p><strong>Syntax</strong>: <br>
compression off <br>
compression <em>algorithm</em> <br>
compression <em>algorithm</em> <em>level</em> <br>
<strong>Default</strong>: off</p>
<p>Apply compression to message contents.
Supported algorithms: lz4, zstd.</p>
<p><strong>Syntax</strong>: appendlimit <em>size</em> <br>
<strong>Default</strong>: 32M</p>
<p>Don't allow users to add new messages larger than 'size'.</p>
<p>This does not affect messages added when using module as a delivery target.
Use 'max_message_size' directive in SMTP endpoint module to restrict it too.</p>
<p><strong>Syntax</strong>: debug <em>boolean</em> <br>
<strong>Default</strong>: global directive value</p>
<p>Enable verbose logging.</p>
<p><strong>Syntax</strong>: junk_mailbox <em>name</em> <br>
<strong>Default</strong>: Junk</p>
<p>The folder to put quarantined messages in. Thishis setting is not used if user
does have a folder with "Junk" special-use attribute.</p>
<p><strong>Syntax</strong>: disable_recent <em>boolean</em> <br>
*Default: true</p>
<p>Disable RFC 3501-conforming handling of \Recent flag.</p>
<p>This significantly improves storage performance when SQLite3 or CockroackDB is
used at the cost of confusing clients that use this flag.</p>
<p><strong>Syntax</strong>: sqlite_cache_size <em>integer</em> <br>
<strong>Default</strong>: defined by SQLite</p>
<p>SQLite page cache size. If positive - specifies amount of pages (1 page - 4
KiB) to keep in cache. If negative - specifies approximate upper bound
of cache size in KiB.</p>
<p><strong>Syntax</strong>: sqlite_busy_timeout <em>integer</em> <br>
<strong>Default</strong>: 5000000</p>
<p>SQLite-specific performance tuning option. Amount of milliseconds to wait
before giving up on DB lock.</p>
<p><strong>Syntax</strong>: imap_filter { ... } <br>
<strong>Default</strong>: not set</p>
<p>Specifies IMAP filters to apply for messages delivered from SMTP pipeline.</p>
<p>Ex.</p>
<pre class="codehilite"><code>imap_filter {
    command /etc/maddy/sieve.sh {account_name}
}
</code></pre>

<p><strong>Syntax:</strong> delivery_map <strong>table</strong> <br>
<strong>Default:</strong> identity</p>
<p>Use specified table module to map recipient
addresses from incoming messages to mailbox names.</p>
<p>Normalization algorithm specified in delivery_normalize is appied before
delivery_map.</p>
<p><strong>Syntax:</strong> delivery_normalize <em>name</em> <br>
<strong>Default:</strong> precis_casefold_email</p>
<p>Normalization function to apply to email addresses before mapping them
to mailboxes.</p>
<p>See auth_normalize.</p>
<p><strong>Syntax</strong>: auth_map <strong>table</strong> <br>
<strong>Default</strong>: identity</p>
<p>Use specified table module to map authentication
usernames to mailbox names.</p>
<p>Normalization algorithm specified in auth_normalize is applied before
auth_map.</p>
<p><strong>Syntax</strong>: auth_normalize <em>name</em> <br>
<strong>Default</strong>: precis_casefold_email</p>
<p>Normalization function to apply to authentication usernames before mapping
them to mailboxes.</p>
<p>Available options:
- precis_casefold_email   PRECIS UsernameCaseMapped profile + U-labels form for domain
- precis_casefold         PRECIS UsernameCaseMapped profile for the entire string
- precis_email            PRECIS UsernameCasePreserved profile + U-labels form for domain
- precis                  PRECIS UsernameCasePreserved profile for the entire string
- casefold                Convert to lower case
- noop                    Nothing</p>
<p>Note: On message delivery, recipient address is unconditionally normalized
using precis_casefold_email function.</p>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../../../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../../../tutorials/setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/alias-to-remote/"
				class="">
			Forward messages to a remote MX</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/pam/"
				class="">
			Using PAM authentication</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="../../../multiple-domains/"
				class="">
			Multiple domains configuration</a>

        
    </li>

    <li>
		<a href="../../../upgrading/"
				class="">
			Upgrading from older maddy versions</a>

        
    </li>

    <li>
		<a href="../../../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../../../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../../modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../../global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../../tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../../tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../../endpoints/imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="../../endpoints/smtp/"
				class="">
			SMTP/LMTP/Submission endpoint</a>

        
    </li>
            
                <li>
		<a href="../../endpoints/openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="./"
				class="current">
			SQL-indexed storage</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#arguments">Arguments</a>
                    </li>
                
                    <li class="local">
                        <a href="#configuration-directives">Configuration directives</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../../blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../../blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../../targets/queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="../../targets/remote/"
				class="">
			Remote MX delivery</a>

        
    </li>
            
                <li>
		<a href="../../targets/smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../../checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../../checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../../checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../../checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../../checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../../checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../../checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../../checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../../modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../../modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../../table/static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../../table/regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../../table/file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="../../table/sql_query/"
				class="">
			SQL query mapping</a>

        
    </li>
            
                <li>
		<a href="../../table/chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../../table/email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../../table/auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../../auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../../auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../../auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../../auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../../auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../../auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../../auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../../../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../../../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../../../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../../../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../../../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '../../..';</script>
<script src="../../../search/main.js" defer></script>


</body>
</html>

