<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../../../css/style2.css">
  <link rel="stylesheet" href="../../../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>SMTP/LMTP/Submission endpoint - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="../../..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="smtplmtpsubmission-endpoint">SMTP/LMTP/Submission endpoint</h1>
<p>Module 'smtp' is a listener that implements ESMTP protocol with optional
authentication, LMTP and Submission support. Incoming messages are processed in
accordance with pipeline rules (explained in Message pipeline section below).</p>
<pre class="codehilite"><code>smtp tcp://0.0.0.0:25 {
    hostname example.org
    tls /etc/ssl/private/cert.pem /etc/ssl/private/pkey.key
    io_debug no
    debug no
    insecure_auth no
    read_timeout 10m
    write_timeout 1m
    max_message_size 32M
    max_header_size 1M
    auth pam
    defer_sender_reject yes
    dmarc yes
    smtp_max_line_length 4000
    limits {
        endpoint rate 10
        endpoint concurrency 500
    }

    # Example pipeline ocnfiguration.
    destination example.org {
        deliver_to &amp;local_mailboxes
    }
    default_destination {
        reject
    }
}
</code></pre>

<h2 id="configuration-directives">Configuration directives</h2>
<p><strong>Syntax</strong>: hostname <em>string</em> <br>
<strong>Default</strong>: global directive value</p>
<p>Server name to use in SMTP banner.</p>
<pre class="codehilite"><code>220 example.org ESMTP Service Ready
</code></pre>

<p><strong>Syntax</strong>: tls <em>certificate_path</em> <em>key_path</em> { ... } <br>
<strong>Default</strong>: global directive value</p>
<p>TLS certificate &amp; key to use. Fine-tuning of other TLS properties is possible
by specifing a configuration block and options inside it:</p>
<pre class="codehilite"><code>tls cert.crt key.key {
    protocols tls1.2 tls1.3
}
</code></pre>

<p>See <a href="/reference/tls/#server-side">TLS configuration / Server</a> for details.</p>
<p><strong>Syntax</strong>: io_debug <em>boolean</em> <br>
<strong>Default</strong>: no</p>
<p>Write all commands and responses to stderr.</p>
<p><strong>Syntax</strong>: debug <em>boolean</em> <br>
<strong>Default</strong>: global directive value</p>
<p>Enable verbose logging.</p>
<p><strong>Syntax</strong>: insecure_auth <em>boolean</em> <br>
<strong>Default</strong>: no (yes if TLS is disabled)</p>
<p>Allow plain-text authentication over unencrypted connections. Not recommended!</p>
<p><strong>Syntax</strong>: read_timeout <em>duration</em> <br>
<strong>Default</strong>: 10m</p>
<p>I/O read timeout.</p>
<p><strong>Syntax</strong>: write_timeout <em>duration</em> <br>
<strong>Default</strong>: 1m</p>
<p>I/O write timeout.</p>
<p><strong>Syntax</strong>: max_message_size <em>size</em> <br>
<strong>Default</strong>: 32M</p>
<p>Limit the size of incoming messages to 'size'.</p>
<p><strong>Syntax</strong>: max_header_size <em>size</em> <br>
<strong>Default</strong>: 1M</p>
<p>Limit the size of incoming message headers to 'size'.</p>
<p><strong>Syntax</strong>: auth <em>module_reference</em> <br>
<strong>Default</strong>: not specified</p>
<p>Use the specified module for authentication.</p>
<p><strong>Syntax</strong>: defer_sender_reject <em>boolean</em> <br>
<strong>Default</strong>: yes</p>
<p>Apply sender-based checks and routing logic when first RCPT TO command
is received. This allows maddy to log recipient address of the rejected
message and also improves interoperability with (improperly implemented)
clients that don't expect an error early in session.</p>
<p><strong>Syntax</strong>: max_logged_rcpt_errors <em>integer</em> <br>
<strong>Default</strong>: 5</p>
<p>Amount of RCPT-time errors that should be logged. Further errors will be
handled silently. This is to prevent log flooding during email dictonary
attacks (address probing).</p>
<p><strong>Syntax</strong>: max_received <em>integer</em> <br>
<strong>Default</strong>: 50</p>
<p>Max. amount of Received header fields in the message header. If the incoming
message has more fields than this number, it will be rejected with the permanent error
5.4.6 ("Routing loop detected").</p>
<p><strong>Syntax</strong>: <br>
buffer ram <br>
buffer fs <em>[path]</em> <br>
buffer auto <em>max_size</em> <em>[path]</em> <br>
<strong>Default</strong>: auto 1M StateDirectory/buffer</p>
<p>Temporary storage to use for the body of accepted messages.</p>
<ul>
<li>ram</li>
</ul>
<p>Store the body in RAM.</p>
<ul>
<li>fs</li>
</ul>
<p>Write out the message to the FS and read it back as needed.
<em>path</em> can be omitted and defaults to StateDirectory/buffer.</p>
<ul>
<li>auto</li>
</ul>
<p>Store message bodies smaller than <em>max_size</em> entirely in RAM, otherwise write
them out to the FS.
<em>path</em> can be omitted and defaults to StateDirectory/buffer.</p>
<p><strong>Syntax</strong>: smtp_max_line_length <em>integer</em> <br>
<strong>Default</strong>: 4000</p>
<p>The maximum line length allowed in the SMTP input stream. If client sends a
longer line - connection will be closed and message (if any) will be rejected
with a permanent error.</p>
<p>RFC 5321 has the recommended limit of 998 bytes. Servers are not required
to handle longer lines correctly but some senders may produce them.</p>
<p>Unless BDAT extension is used by the sender, this limitation also applies to
the message body.</p>
<p><strong>Syntax</strong>: dmarc <em>boolean</em> <br>
<strong>Default</strong>: yes</p>
<p>Enforce sender's DMARC policy. Due to implementation limitations, it is not a
check module.</p>
<p><strong>NOTE</strong>: Report generation is not implemented now.</p>
<p><strong>NOTE</strong>: DMARC needs SPF and DKIM checks to function correctly.
Without these, DMARC check will not run.</p>
<h2 id="rate-concurrency-limiting">Rate &amp; concurrency limiting</h2>
<p><strong>Syntax</strong>: limits <em>config block</em> <br>
<strong>Default</strong>: no limits</p>
<p>This allows configuring a set of message flow restrictions including
max. concurrency and rate per-endpoint, per-source, per-destination.</p>
<p>Limits are specified as directives inside the block:</p>
<pre class="codehilite"><code>limits {
    all rate 20
    destination concurrency 5
}
</code></pre>

<p>Supported limits:</p>
<ul>
<li>Rate limit</li>
</ul>
<p><strong>Syntax</strong>: <em>scope</em> rate <em>burst</em> <em>[period]</em> <br>
Restrict the amount of messages processed in <em>period</em> to <em>burst</em> messages.
If period is not specified, 1 second is used.</p>
<ul>
<li>Concurrency limit</li>
</ul>
<p><strong>Syntax</strong>: <em>scope</em> concurrency <em>max</em> <br>
Restrict the amount of messages processed in parallel to _max_.</p>
<p>For each supported limitation, <em>scope</em> determines whether it should be applied
for all messages ("all"), per-sender IP ("ip"), per-sender domain ("source") or
per-recipient domain ("destination"). Having a scope other than "all" means
that the restriction will be enforced independently for each group determined
by scope. E.g.  "ip rate 20" means that the same IP cannot send more than 20
messages in a scond. "destination concurrency 5" means that no more than 5
messages can be sent in parallel to a single domain.</p>
<p><strong>Note</strong>: At the moment, SMTP endpoint on its own does not support per-recipient
limits.  They will be no-op. If you want to enforce a per-recipient restriction
on outbound messages, do so using 'limits' directive for the 'table.remote' module</p>
<p>It is possible to share limit counters between multiple endpoints (or any other
modules). To do so define a top-level configuration block for module "limits"
and reference it where needed using standard &amp; syntax. E.g.</p>
<pre class="codehilite"><code>limits inbound_limits {
    all rate 20
}

smtp smtp://0.0.0.0:25 {
    limits &amp;inbound_limits
    ...
}

submission tls://0.0.0.0:465 {
    limits &amp;inbound_limits
    ...
}
</code></pre>

<p>Using an "all rate" restriction in such way means that no more than 20
messages can enter the server through both endpoints in one second.</p>
<h1 id="submission-module-submission">Submission module (submission)</h1>
<p>Module 'submission' implements all functionality of the 'smtp' module and adds
certain message preprocessing on top of it, additionaly authentication is
always required.</p>
<p>'submission' module checks whether addresses in header fields From, Sender, To,
Cc, Bcc, Reply-To are correct and adds Message-ID and Date if it is missing.</p>
<pre class="codehilite"><code>submission tcp://0.0.0.0:587 tls://0.0.0.0:465 {
    # ... same as smtp ...
}
</code></pre>

<h1 id="lmtp-module-lmtp">LMTP module (lmtp)</h1>
<p>Module 'lmtp' implements all functionality of the 'smtp' module but uses
LMTP (RFC 2033) protocol.</p>
<pre class="codehilite"><code>lmtp unix://lmtp.sock {
    # ... same as smtp ...
}
</code></pre>

<h2 id="limitations-of-lmtp-implementation">Limitations of LMTP implementation</h2>
<ul>
<li>
<p>Can't be used with TCP.</p>
</li>
<li>
<p>Delivery to 'sql' module storage is always atomic, either all recipients will
  succeed or none of them will.</p>
</li>
</ul>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../../../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../../../tutorials/setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/alias-to-remote/"
				class="">
			Forward messages to a remote MX</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/pam/"
				class="">
			Using PAM authentication</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="../../../multiple-domains/"
				class="">
			Multiple domains configuration</a>

        
    </li>

    <li>
		<a href="../../../upgrading/"
				class="">
			Upgrading from older maddy versions</a>

        
    </li>

    <li>
		<a href="../../../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../../../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../../modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../../global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../../tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../../tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="./"
				class="current">
			SMTP/LMTP/Submission endpoint</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#configuration-directives">Configuration directives</a>
                    </li>
                
                    <li class="local">
                        <a href="#rate-concurrency-limiting">Rate &amp; concurrency limiting</a>
                    </li>
                
                </ul>
            
        
			
        
			
                <ul>
                
                    <li class="local">
                        <a href="#limitations-of-lmtp-implementation">Limitations of LMTP implementation</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>
            
                <li>
		<a href="../openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../../storage/imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="../../storage/imapsql/"
				class="">
			SQL-indexed storage</a>

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../../blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../../blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../../targets/queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="../../targets/remote/"
				class="">
			Remote MX delivery</a>

        
    </li>
            
                <li>
		<a href="../../targets/smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../../checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../../checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../../checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../../checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../../checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../../checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../../checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../../checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../../modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../../modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../../table/static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../../table/regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../../table/file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="../../table/sql_query/"
				class="">
			SQL query mapping</a>

        
    </li>
            
                <li>
		<a href="../../table/chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../../table/email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../../table/auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../../auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../../auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../../auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../../auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../../auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../../auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../../auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../../../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../../../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../../../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../../../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../../../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '../../..';</script>
<script src="../../../search/main.js" defer></script>


</body>
</html>

