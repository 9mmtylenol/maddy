<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../../../css/style2.css">
  <link rel="stylesheet" href="../../../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>Remote MX delivery - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="../../..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="remote-mx-delivery">Remote MX delivery</h1>
<p>Module that implements message delivery to remote MTAs discovered via DNS MX
records. You probably want to use it with queue module for reliability.</p>
<p>If a message check marks a message as 'quarantined', remote module
will refuse to deliver it.</p>
<h2 id="configuration-directives">Configuration directives</h2>
<pre class="codehilite"><code>target.remote {
    hostname mx.example.org
    debug no
}
</code></pre>

<p><strong>Syntax</strong>: hostname <em>domain</em> <br>
<strong>Default</strong>: global directive value</p>
<p>Hostname to use client greeting (EHLO/HELO command). Some servers require it to
be FQDN, SPF-capable servers check whether it corresponds to the server IP
address, so it is better to set it to a domain that resolves to the server IP.</p>
<p><strong>Syntax</strong>: limits <em>config block</em> <br>
<strong>Default</strong>: no limits</p>
<p>See <a href="/reference/endpoints/smtp/#rate-concurrency-limiting">'limits' directive for SMTP endpoint</a>.
It works the same except for address domains used for
per-source/per-destination are as observed when message exits the server.</p>
<p><strong>Syntax</strong>: local_ip <em>IP address</em> <br>
<strong>Default</strong>: empty</p>
<p>Choose the local IP to bind for outbound SMTP connections.</p>
<p><strong>Syntax</strong>: force_ipv4 <em>boolean</em> <br>
<strong>Default</strong>: false</p>
<p>Force resolving outbound SMTP domains to IPv4 addresses. Some server providers
do not offer a way to properly set reverse PTR domains for IPv6 addresses; this
option makes maddy only connect to IPv4 addresses so that its public IPv4 address
is used to connect to that server, and thus reverse PTR checks are made against
its IPv4 address.</p>
<p>Warning: this may break sending outgoing mail to IPv6-only SMTP servers.</p>
<p><strong>Syntax</strong>: connect_timeout <em>duration</em> <br>
<strong>Default</strong>: 5m</p>
<p>Timeout for TCP connection establishment.</p>
<p>RFC 5321 recommends 5 minutes for "initial greeting" that includes TCP
handshake. maddy uses two separate timers - one for "dialing" (DNS A/AAAA
lookup + TCP handshake) and another for "initial greeting". This directive
configures the former. The latter is not configurable and is hardcoded to be
5 minutes.</p>
<p><strong>Syntax</strong>: command_timeout <em>duration</em> <br>
<strong>Default</strong>: 5m</p>
<p>Timeout for any SMTP command (EHLO, MAIL, RCPT, DATA, etc).</p>
<p>If STARTTLS is used this timeout also applies to TLS handshake.</p>
<p>RFC 5321 recommends 5 minutes for MAIL/RCPT and 3 minutes for
DATA.</p>
<p><strong>Syntax</strong>: submission_timeout <em>duration</em> <br>
<strong>Default</strong>: 12m</p>
<p>Time to wait after the entire message is sent (after "final dot").</p>
<p>RFC 5321 recommends 10 minutes.</p>
<p><strong>Syntax</strong>: debug <em>boolean</em> <br>
<strong>Default</strong>: global directive value</p>
<p>Enable verbose logging.</p>
<p><strong>Syntax</strong>: requiretls_override <em>boolean</em> <br>
<strong>Default</strong>: true</p>
<p>Allow local security policy to be disabled using 'TLS-Required' header field in
sent messages. Note that the field has no effect if transparent forwarding is
used, message body should be processed before outbound delivery starts for it
to take effect (e.g. message should be queued using 'queue' module).</p>
<p><strong>Syntax</strong>: relaxed_requiretls <em>boolean</em> <br>
<strong>Default</strong>: true</p>
<p>This option disables strict conformance with REQUIRETLS specification and
allows forwarding of messages 'tagged' with REQUIRETLS to MXes that are not
advertising REQUIRETLS support. It is meant to allow REQUIRETLS use without the
need to have support from all servers. It is based on the assumption that
server referenced by MX record is likely the final destination and therefore
there is only need to secure communication towards it and not beyond.</p>
<p><strong>Syntax</strong>: conn_reuse_limit <em>integer</em> <br>
<strong>Default</strong>: 10</p>
<p>Amount of times the same SMTP connection can be used.
Connections are never reused if the previous DATA command failed.</p>
<p><strong>Syntax</strong>: conn_max_idle_count <em>integer</em> <br>
<strong>Default</strong>: 10</p>
<p>Max. amount of idle connections per recipient domains to keep in cache.</p>
<p><strong>Syntax</strong>: conn_max_idle_time <em>integer</em> <br>
<strong>Default</strong>: 150 (2.5 min)</p>
<p>Amount of time the idle connection is still considered potentially usable.</p>
<h2 id="security-policies">Security policies</h2>
<p><strong>Syntax</strong>: mx_auth <em>config block</em> <br>
<strong>Default</strong>: no policies</p>
<p>'remote' module implements a number of of schemes and protocols necessary to
ensure security of message delivery. Most of these schemes are concerned with
authentication of recipient server and TLS enforcement.</p>
<p>To enable mechanism, specify its name in the mx_auth directive block:</p>
<pre class="codehilite"><code>mx_auth {
    dane
    mtasts
}
</code></pre>

<p>Additional configuration is possible if supported by the mechanism by
specifying additional options as a block for the corresponding mechanism.
E.g.</p>
<pre class="codehilite"><code>mtasts {
    cache ram
}
</code></pre>

<p>If the mx_auth directive is not specified, no mechanisms are enabled. Note
that, however, this makes outbound SMTP vulnerable to a numberous downgrade
attacks and hence not recommended.</p>
<p>It is possible to share the same set of policies for multiple 'remote' module
instances by defining it at the top-level using 'mx_auth' module and then
referencing it using standard &amp; syntax:</p>
<pre class="codehilite"><code>mx_auth outbound_policy {
    dane
    mtasts {
        cache ram
    }
}

# ... somewhere else ...

deliver_to remote {
    mx_auth &amp;outbound_policy
}

# ... somewhere else ...

deliver_to remote {
    mx_auth &amp;outbound_policy
    tls_client { ... }
}
</code></pre>

<h3 id="mta-sts">MTA-STS</h3>
<p>Checks MTA-STS policy of the recipient domain. Provides proper authentication
and TLS enforcement for delivery, but partially vulnerable to persistent active
attacks.</p>
<p>Sets MX level to "mtasts" if the used MX matches MTA-STS policy even if it is
not set to "enforce" mode.</p>
<pre class="codehilite"><code>mtasts {
    cache fs
    fs_dir StateDirectory/mtasts_cache
}
</code></pre>

<p><strong>Syntax</strong>: cache fs|ram <br>
<strong>Default</strong>: fs</p>
<p>Storage to use for MTA-STS cache. 'fs' is to use a filesystem directory, 'ram'
to store the cache in memory.</p>
<p>It is recommended to use 'fs' since that will not discard the cache (and thus
cause MTA-STS security to disappear) on server restart. However, using the RAM
cache can make sense for high-load configurations with good uptime.</p>
<p><strong>Syntax</strong>: fs_dir <em>directory</em> <br>
<strong>Default</strong>: StateDirectory/mtasts_cache</p>
<p>Filesystem directory to use for policies caching if 'cache' is set to 'fs'.</p>
<h3 id="dnssec">DNSSEC</h3>
<p>Checks whether MX records are signed. Sets MX level to "dnssec" is they are.</p>
<p>maddy does not validate DNSSEC signatures on its own. Instead it reslies on
the upstream resolver to do so by causing lookup to fail when verification
fails and setting the AD flag for signed and verfified zones. As a safety
measure, if the resolver is not 127.0.0.1 or ::1, the AD flag is ignored.</p>
<p>DNSSEC is currently not supported on Windows and other platforms that do not
have the /etc/resolv.conf file in the standard format.</p>
<pre class="codehilite"><code>dnssec { }
</code></pre>

<h3 id="dane">DANE</h3>
<p>Checks TLSA records for the recipient MX. Provides downgrade-resistant TLS
enforcement.</p>
<p>Sets TLS level to "authenticated" if a valid and matching TLSA record uses
DANE-EE or DANE-TA usage type.</p>
<p>See above for notes on DNSSEC. DNSSEC support is required for DANE to work.</p>
<pre class="codehilite"><code>dane { }
</code></pre>

<h3 id="local-policy">Local policy</h3>
<p>Checks effective TLS and MX levels (as set by other policies) against local
configuration.</p>
<pre class="codehilite"><code>local_policy {
    min_tls_level none
    min_mx_level none
}
</code></pre>

<p>Using 'local_policy off' is equivalent to setting both directives to 'none'.</p>
<p><strong>Syntax</strong>: min_tls_level none|encrypted|authenticated <br>
<strong>Default</strong>: none</p>
<p>Set the minimal TLS security level required for all outbound messages.</p>
<p>See <a href="../../seclevels">Security levels</a> page for details.</p>
<p><strong>Syntax</strong>: min_mx_level: none|mtasts|dnssec <br>
<strong>Default</strong>: none</p>
<p>Set the minimal MX security level required for all outbound messages.</p>
<p>See <a href="../../seclevels">Security levels</a> page for details.</p>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../../../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../../../tutorials/setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/alias-to-remote/"
				class="">
			Forward messages to a remote MX</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/pam/"
				class="">
			Using PAM authentication</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="../../../multiple-domains/"
				class="">
			Multiple domains configuration</a>

        
    </li>

    <li>
		<a href="../../../upgrading/"
				class="">
			Upgrading from older maddy versions</a>

        
    </li>

    <li>
		<a href="../../../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../../../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../../modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../../global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../../tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../../tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../../endpoints/imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="../../endpoints/smtp/"
				class="">
			SMTP/LMTP/Submission endpoint</a>

        
    </li>
            
                <li>
		<a href="../../endpoints/openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../../storage/imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="../../storage/imapsql/"
				class="">
			SQL-indexed storage</a>

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../../blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../../blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="./"
				class="current">
			Remote MX delivery</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#configuration-directives">Configuration directives</a>
                    </li>
                
                    <li class="local">
                        <a href="#security-policies">Security policies</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>
            
                <li>
		<a href="../smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../../checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../../checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../../checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../../checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../../checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../../checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../../checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../../checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../../modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../../modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../../table/static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../../table/regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../../table/file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="../../table/sql_query/"
				class="">
			SQL query mapping</a>

        
    </li>
            
                <li>
		<a href="../../table/chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../../table/email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../../table/auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../../auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../../auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../../auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../../auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../../auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../../auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../../auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../../../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../../../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../../../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../../../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../../../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '../../..';</script>
<script src="../../../search/main.js" defer></script>


</body>
</html>

