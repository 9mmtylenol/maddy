<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="../../../css/style2.css">
  <link rel="stylesheet" href="../../../css/mkdocs.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="ICBM" content="-37.1114, -56.8678">
<title>SQL query mapping - maddy</title>
</head>
<body>

<header>
<nav>
<h1><a href="../../..">maddy</a></h1>
</nav>
</header>

<main>

<div class="content">

<h1 id="sql-query-mapping">SQL query mapping</h1>
<p>The table.sql_query module implements table interface using SQL queries.</p>
<p>Definition:</p>
<pre class="codehilite"><code>table.sql_query {
    driver &lt;driver name&gt;
    dsn &lt;data source name&gt;
    lookup &lt;lookup query&gt;

    # Optional:
    init &lt;init query list&gt;
    list &lt;list query&gt;
    add &lt;add query&gt;
    del &lt;del query&gt;
    set &lt;set query&gt;
}
</code></pre>

<p>Usage example:</p>
<pre class="codehilite"><code># Resolve SMTP address aliases using PostgreSQL DB.
modify {
    replace_rcpt sql_query {
        driver postgres
        dsn &quot;dbname=maddy user=maddy&quot;
        lookup &quot;SELECT alias FROM aliases WHERE address = $1&quot;
    }
}
</code></pre>

<h2 id="configuration-directives">Configuration directives</h2>
<p><strong><em>Syntax</em></strong>: driver <em>driver name</em> <br>
<strong><em>REQUIRED</em></strong></p>
<p>Driver to use to access the database.</p>
<p>Supported drivers: postgres, sqlite3 (if compiled with C support)</p>
<p><strong><em>Syntax</em></strong>: dsn <em>data source name</em> <br>
<strong><em>REQUIRED</em></strong></p>
<p>Data Source Name to pass to the driver. For SQLite3 this is just a path to DB
file. For Postgres, see
<a href="https://pkg.go.dev/github.com/lib/pq?tab=doc#hdr-Connection_String_Parameters">https://pkg.go.dev/github.com/lib/pq?tab=doc#hdr-Connection_String_Parameters</a></p>
<p><strong><em>Syntax</em></strong>: lookup <em>query</em> <br>
<strong><em>REQUIRED</em></strong></p>
<p>SQL query to use to obtain the lookup result.</p>
<p>It will get one named argument containing the lookup key. Use :key
placeholder to access it in SQL. The result row set should contain one row, one
column with the string that will be used as a lookup result. If there are more
rows, they will be ignored. If there are more columns, lookup will fail.  If
there are no rows, lookup returns "no results". If there are any error - lookup
will fail.</p>
<p><strong><em>Syntax</em></strong>: init <em>queries...</em> <br>
<strong><em>Default</em></strong>: empty</p>
<p>List of queries to execute on initialization. Can be used to configure RDBMS.</p>
<p>Example, to improve SQLite3 performance:</p>
<pre class="codehilite"><code>table.sql_query {
    driver sqlite3
    dsn whatever.db
    init &quot;PRAGMA journal_mode=WAL&quot; \
        &quot;PRAGMA synchronous=NORMAL&quot;
    lookup &quot;SELECT alias FROM aliases WHERE address = $1&quot;
}
</code></pre>

<p><strong>Syntax:</strong> named_args <em>boolean</em> <br>
<strong>Default:</strong> yes</p>
<p>Whether to use named parameters binding when executing SQL queries
or not.</p>
<p>Note that maddy's PostgreSQL driver does not support named parameters and
SQLite3 driver has issues handling numbered parameters:
<a href="https://github.com/mattn/go-sqlite3/issues/472">https://github.com/mattn/go-sqlite3/issues/472</a></p>
<p><strong><em>Syntax:</em></strong> add <em>query</em> <br>
<strong><em>Syntax:</em></strong> list <em>query</em> <br>
<strong><em>Syntax:</em></strong> set <em>query</em> <br>
<strong><em>Syntax:</em></strong> del <em>query</em> <br>
<strong><em>Default:</em></strong> none</p>
<p>If queries are set to implement corresponding table operations - table becomes
"mutable" and can be used in contexts that require writable key-value store.</p>
<p>'add' query gets :key, :value named arguments - key and value strings to store.
They should be added to the store. The query <strong>should</strong> not add multiple values
for the same key and <strong>should</strong> fail if the key already exists.</p>
<p>'list' query gets no arguments and should return a column with all keys in
the store.</p>
<p>'set' query gets :key, :value named arguments - key and value and should replace the existing
entry in the database.</p>
<p>'del' query gets :key argument - key and should remove it from the database.</p>
<p>If named_args is set to "no" - key is passed as the first numbered parameter
($1), value is passed as the second numbered parameter ($2).</p>
</div>

<div class="side">




<div class="search">
  <form class="search" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs"
        title="Type search term here" />
  </form>
</div>


<div class="toc" aria-label="main navigation">
<ul>

    <li>
		<a href="../../../faq/"
				class="">
			Frequently Asked Questions</a>

        
    </li>

    <li>
		<span>Tutorials</span>

        
            <ul>
            
                <li>
		<a href="../../../tutorials/setting-up/"
				class="">
			Installation & initial configuration</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/building-from-source/"
				class="">
			Building from source</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/alias-to-remote/"
				class="">
			Forward messages to a remote MX</a>

        
    </li>
            
                <li>
		<a href="../../../tutorials/pam/"
				class="">
			Using PAM authentication</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<a href="https://maddy.email/builds/"
				class="">
			Release builds</a>

        
    </li>

    <li>
		<a href="../../../multiple-domains/"
				class="">
			Multiple domains configuration</a>

        
    </li>

    <li>
		<a href="../../../upgrading/"
				class="">
			Upgrading from older maddy versions</a>

        
    </li>

    <li>
		<a href="../../../seclevels/"
				class="">
			Outbound delivery security</a>

        
    </li>

    <li>
		<a href="../../../docker/"
				class="">
			Docker</a>

        
    </li>

    <li>
		<span>Reference manual</span>

        
            <ul>
            
                <li>
		<a href="../../modules/"
				class="">
			Modules introduction</a>

        
    </li>
            
                <li>
		<a href="../../global-config/"
				class="">
			Global configuration directives</a>

        
    </li>
            
                <li>
		<a href="../../tls/"
				class="">
			TLS configuration</a>

        
    </li>
            
                <li>
		<a href="../../tls-acme/"
				class="">
			Automatic certificate management via ACME</a>

        
    </li>
            
                <li>
		<span>Endpoints configuration</span>

        
            <ul>
            
                <li>
		<a href="../../endpoints/imap/"
				class="">
			IMAP4rev1 endpoint</a>

        
    </li>
            
                <li>
		<a href="../../endpoints/smtp/"
				class="">
			SMTP/LMTP/Submission endpoint</a>

        
    </li>
            
                <li>
		<a href="../../endpoints/openmetrics/"
				class="">
			OpenMetrics/Prometheus telemetry</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>IMAP storage</span>

        
            <ul>
            
                <li>
		<a href="../../storage/imap-filters/"
				class="">
			IMAP filters</a>

        
    </li>
            
                <li>
		<a href="../../storage/imapsql/"
				class="">
			SQL-indexed storage</a>

        
    </li>
            
                <li>
		<span>Blob storage</span>

        
            <ul>
            
                <li>
		<a href="../../blob/fs/"
				class="">
			Filesystem</a>

        
    </li>
            
                <li>
		<a href="../../blob/s3/"
				class="">
			Amazon S3</a>

        
    </li>
            
            </ul>
        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../smtp-pipeline/"
				class="">
			SMTP message routing (pipeline)</a>

        
    </li>
            
                <li>
		<span>SMTP targets</span>

        
            <ul>
            
                <li>
		<a href="../../targets/queue/"
				class="">
			Local queue</a>

        
    </li>
            
                <li>
		<a href="../../targets/remote/"
				class="">
			Remote MX delivery</a>

        
    </li>
            
                <li>
		<a href="../../targets/smtp/"
				class="">
			SMTP & LMTP transparent forwarding</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP checks</span>

        
            <ul>
            
                <li>
		<a href="../../checks/actions/"
				class="">
			Check actions</a>

        
    </li>
            
                <li>
		<a href="../../checks/dkim/"
				class="">
			DKIM</a>

        
    </li>
            
                <li>
		<a href="../../checks/spf/"
				class="">
			SPF</a>

        
    </li>
            
                <li>
		<a href="../../checks/milter/"
				class="">
			Milter client</a>

        
    </li>
            
                <li>
		<a href="../../checks/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../checks/dnsbl/"
				class="">
			DNSBL lookup</a>

        
    </li>
            
                <li>
		<a href="../../checks/command/"
				class="">
			System command filter</a>

        
    </li>
            
                <li>
		<a href="../../checks/authorize_sender/"
				class="">
			MAIL FROM and From authorization</a>

        
    </li>
            
                <li>
		<a href="../../checks/misc/"
				class="">
			Misc checks</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>SMTP modifiers</span>

        
            <ul>
            
                <li>
		<a href="../../modifiers/dkim/"
				class="">
			DKIM signing</a>

        
    </li>
            
                <li>
		<a href="../../modifiers/envelope/"
				class="">
			Envelope sender / recipient rewriting</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Lookup tables (string translation)</span>

        
            <ul>
            
                <li>
		<a href="../static/"
				class="">
			Static table</a>

        
    </li>
            
                <li>
		<a href="../regexp/"
				class="">
			Regexp rewrite table</a>

        
    </li>
            
                <li>
		<a href="../file/"
				class="">
			File</a>

        
    </li>
            
                <li>
		<a href="./"
				class="current">
			SQL query mapping</a>
		
			
                <ul>
                
                    <li class="local">
                        <a href="#configuration-directives">Configuration directives</a>
                    </li>
                
                </ul>
            
        
        

        
    </li>
            
                <li>
		<a href="../chain/"
				class="">
			Table chaining</a>

        
    </li>
            
                <li>
		<a href="../email_localpart/"
				class="">
			Email local part</a>

        
    </li>
            
                <li>
		<a href="../auth/"
				class="">
			Authentication providers</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<span>Authentication providers</span>

        
            <ul>
            
                <li>
		<a href="../../auth/pass_table/"
				class="">
			Password table</a>

        
    </li>
            
                <li>
		<a href="../../auth/pam/"
				class="">
			PAM</a>

        
    </li>
            
                <li>
		<a href="../../auth/shadow/"
				class="">
			/etc/shadow</a>

        
    </li>
            
                <li>
		<a href="../../auth/external/"
				class="">
			System command</a>

        
    </li>
            
                <li>
		<a href="../../auth/ldap/"
				class="">
			LDAP BindDN</a>

        
    </li>
            
                <li>
		<a href="../../auth/dovecot_sasl/"
				class="">
			Dovecot SASL</a>

        
    </li>
            
                <li>
		<a href="../../auth/plain_separate/"
				class="">
			Separate username and password lookup</a>

        
    </li>
            
            </ul>
        
    </li>
            
                <li>
		<a href="../../config-syntax/"
				class="">
			Configuration files syntax</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Integration with software</span>

        
            <ul>
            
                <li>
		<a href="../../../third-party/dovecot/"
				class="">
			Dovecot</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/smtp-servers/"
				class="">
			External SMTP server</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/rspamd/"
				class="">
			rspamd</a>

        
    </li>
            
                <li>
		<a href="../../../third-party/mailman3/"
				class="">
			Mailman 3</a>

        
    </li>
            
            </ul>
        
    </li>

    <li>
		<span>Internals</span>

        
            <ul>
            
                <li>
		<a href="../../../internals/specifications/"
				class="">
			Followed specifications</a>

        
    </li>
            
                <li>
		<a href="../../../internals/unicode/"
				class="">
			Unicode support</a>

        
    </li>
            
                <li>
		<a href="../../../internals/quirks/"
				class="">
			Implementation quirks</a>

        
    </li>
            
                <li>
		<a href="../../../internals/sqlite/"
				class="">
			maddy & SQLite</a>

        
    </li>
            
            </ul>
        
    </li>

</ul>
</div>
</div>

</main>

<footer>
<div>
Thanks <a href="https://blitiri.com.ar/">Alberto Bertogli</a> for providing base for this neat mkdocs theme!
Last updated: 2022-12-05
</div>
</footer>

<!-- For search -->
<script>var base_url = '../../..';</script>
<script src="../../../search/main.js" defer></script>


</body>
</html>

